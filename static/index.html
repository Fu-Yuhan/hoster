<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸŒ¾ AI æ™ºæ…§å†œä¸šåŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            farm: {
              50:  "#f0fdf4", 100: "#dcfce7", 200: "#bbf7d0",
              400: "#4ade80", 500: "#22c55e", 600: "#16a34a",
              700: "#15803d", 800: "#166534", 900: "#14532d",
            }
          }
        }
      }
    }
  </script>

  <style>
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }

    .md-content h1,.md-content h2,.md-content h3 { font-weight:700; margin:.5em 0 .25em; }
    .md-content h1 { font-size:1.25rem; }
    .md-content h2 { font-size:1.1rem; }
    .md-content h3 { font-size:1rem; }
    .md-content p  { margin:.4em 0; line-height:1.7; }
    .md-content ul,.md-content ol { padding-left:1.5em; margin:.4em 0; }
    .md-content li { margin:.2em 0; }
    .md-content code { background:#f1f5f9; padding:.1em .4em; border-radius:.25em; font-size:.85em; }
    .md-content pre code { background:none; padding:0; font-size:.82em; }
    .md-content pre { background:#1e293b; color:#e2e8f0; padding:.75em 1em; border-radius:.5em; overflow-x:auto; margin:.5em 0; }
    .md-content table { border-collapse:collapse; width:100%; margin:.5em 0; }
    .md-content th,.md-content td { border:1px solid #cbd5e1; padding:.3em .6em; text-align:left; }
    .md-content th { background:#f0fdf4; }
    .md-content blockquote { border-left:3px solid #4ade80; padding-left:.75em; color:#475569; margin:.4em 0; }

    .cursor::after { content:"â–Œ"; animation:blink .7s step-start infinite; }
    @keyframes blink { 50% { opacity:0; } }

    .json-view { font-size:.78rem; }

    .msg-enter { animation:fadeSlideIn .25s ease; }
    @keyframes fadeSlideIn {
      from { opacity:0; transform:translateY(8px); }
      to   { opacity:1; transform:translateY(0); }
    }
  </style>
</head>

<body class="h-full bg-gradient-to-br from-farm-50 to-emerald-50 flex flex-col">
<div id="app" class="h-screen flex flex-col overflow-hidden">

  <!-- é¡¶æ  -->
  <header class="flex-none bg-white/90 backdrop-blur border-b border-farm-200 shadow-sm">
    <div class="max-w-5xl mx-auto px-4 h-14 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl">ğŸŒ¾</span>
        <div>
          <h1 class="text-base font-bold text-farm-800 leading-none">AI æ™ºæ…§å†œä¸šåŠ©æ‰‹</h1>
          <p class="text-xs text-farm-600 leading-none mt-0.5">å†œæ™º Â· æ™ºæ…§å†œåœºç®¡ç†å¹³å°</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-1.5 text-xs">
          <span class="w-2 h-2 rounded-full transition-colors"
            :class="isConnected ? 'bg-farm-500 animate-pulse' : 'bg-slate-300'"></span>
          <span class="text-slate-500">{{ isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥' }}</span>
        </div>
        <button @click="clearSession" :disabled="isStreaming"
          class="flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-slate-600
                 bg-slate-100 hover:bg-slate-200 rounded-lg
                 disabled:opacity-40 disabled:cursor-not-allowed transition">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0
                 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0
                 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
          </svg>
          æ¸…ç©ºå¯¹è¯
        </button>
      </div>
    </div>
  </header>

  <!-- ä¸»ä½“ -->
  <div class="flex-1 flex overflow-hidden max-w-5xl mx-auto w-full">

    <!-- ä¾§æ  -->
    <aside class="hidden md:flex flex-col w-52 flex-none border-r border-farm-100 bg-white/60 py-4 px-3 gap-4">
      <div>
        <p class="text-xs font-semibold text-farm-700 uppercase tracking-wide mb-2">ğŸ“ å†œåœºåŒºåŸŸ</p>
        <div class="flex flex-wrap gap-1.5">
          <span v-for="z in zones" :key="z"
            class="px-2 py-1 bg-farm-100 text-farm-700 text-xs rounded-md font-medium">
            {{ z }}
          </span>
        </div>
      </div>
      <div>
        <p class="text-xs font-semibold text-farm-700 uppercase tracking-wide mb-2">ğŸ“¡ ä¼ æ„Ÿå™¨</p>
        <div class="flex flex-col gap-1">
          <span v-for="s in sensors" :key="s" class="flex items-center gap-1.5 text-xs text-slate-600">
            <span class="w-1.5 h-1.5 rounded-full bg-farm-400"></span>{{ s }}
          </span>
        </div>
      </div>
      <div>
        <p class="text-xs font-semibold text-farm-700 uppercase tracking-wide mb-2">âš¡ å¿«é€ŸæŒ‡ä»¤</p>
        <div class="flex flex-col gap-1.5">
          <button v-for="q in quickPrompts" :key="q.text"
            @click="sendQuick(q.text)" :disabled="isStreaming"
            class="text-left text-xs text-slate-600 hover:text-farm-700 hover:bg-farm-50
                   px-2 py-1.5 rounded-md transition
                   disabled:opacity-40 disabled:cursor-not-allowed leading-snug">
            {{ q.icon }} {{ q.text }}
          </button>
        </div>
      </div>
    </aside>

    <!-- å¯¹è¯åŒº -->
    <main class="flex-1 flex flex-col overflow-hidden">

      <!-- æ¶ˆæ¯åˆ—è¡¨ -->
      <div ref="msgList" class="flex-1 overflow-y-auto px-4 py-4 space-y-4">

        <!-- æ¬¢è¿å± -->
        <div v-if="messages.length === 0"
          class="flex flex-col items-center justify-center h-full gap-4 text-center px-4">
          <div class="text-5xl">ğŸŒ¾</div>
          <div>
            <h2 class="text-xl font-bold text-farm-800">æ¬¢è¿ä½¿ç”¨å†œæ™º</h2>
            <p class="text-slate-500 text-sm mt-1">AI é©±åŠ¨çš„æ™ºæ…§å†œåœºç®¡ç†åŠ©æ‰‹</p>
          </div>
          <div class="grid grid-cols-2 gap-2 mt-2 w-full max-w-sm">
            <button v-for="q in quickPrompts" :key="q.text" @click="sendQuick(q.text)"
              class="text-xs text-left px-3 py-2.5 bg-white border border-farm-200
                     hover:border-farm-400 hover:bg-farm-50 rounded-xl transition shadow-sm text-slate-600">
              <span class="block text-base mb-0.5">{{ q.icon }}</span>
              {{ q.text }}
            </button>
          </div>
        </div>

        <!-- æ¶ˆæ¯æ°”æ³¡ -->
        <template v-for="(msg, idx) in messages" :key="idx">

          <!-- ç”¨æˆ· -->
          <div v-if="msg.role === 'user'" class="flex justify-end msg-enter">
            <div class="max-w-[78%] px-4 py-2.5 bg-farm-600 text-white
                        rounded-2xl rounded-br-sm shadow-sm text-sm leading-relaxed">
              {{ msg.content }}
            </div>
          </div>

          <!-- AI æ–‡æœ¬ -->
          <div v-else-if="msg.role === 'assistant' && msg.content" class="flex gap-3 msg-enter">
            <div class="flex-none w-8 h-8 rounded-full bg-farm-500 flex items-center
                        justify-center text-white text-sm shadow">ğŸŒ±</div>
            <div class="max-w-[82%] bg-white rounded-2xl rounded-tl-sm shadow-sm px-4 py-3 text-sm text-slate-800">
              <div class="md-content" :class="{ cursor: msg.streaming }" v-html="renderMd(msg.content)"></div>
            </div>
          </div>

          <!-- å·¥å…·ç»„ -->
          <div v-else-if="msg.role === 'tool_group'" class="flex gap-3 msg-enter">
            <div class="flex-none w-8 h-8 rounded-full bg-amber-400 flex items-center
                        justify-center text-white text-sm shadow">ğŸ”§</div>
            <div class="max-w-[82%] w-full">
              <div class="bg-amber-50 border border-amber-200 rounded-2xl rounded-tl-sm shadow-sm overflow-hidden">

                <!-- å·¥å…·ç»„å¤´ï¼ˆç‚¹å‡»æŠ˜å ï¼‰ -->
                <button @click="msg.expanded = !msg.expanded"
                  class="w-full flex items-center justify-between px-4 py-2.5
                         text-xs font-medium text-amber-800 hover:bg-amber-100 transition">
                  <span class="flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0
                           002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0
                           001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0
                           00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0
                           00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0
                           00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0
                           00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0
                           001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07
                           2.572-1.065z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span>
                      {{ msg.running ? 'â³ æ­£åœ¨è°ƒç”¨å·¥å…·â€¦' : 'âœ… å·¥å…·è°ƒç”¨å®Œæˆ' }}
                      ï¼ˆ{{ msg.tools.map(t => t.display_name).join('ã€') }}ï¼‰
                    </span>
                  </span>
                  <svg class="w-3.5 h-3.5 transition-transform" :class="msg.expanded ? 'rotate-180' : ''"
                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </button>

                <!-- å·¥å…·è¯¦æƒ… -->
                <div v-show="msg.expanded" class="divide-y divide-amber-200">
                  <div v-for="(tool, ti) in msg.tools" :key="ti" class="px-4 py-3 space-y-2">
                    <div class="flex items-center justify-between">
                      <span class="text-xs font-semibold text-amber-700">{{ tool.display_name }}</span>
                      <span class="text-[10px] px-1.5 py-0.5 rounded-full font-medium"
                        :class="tool.done ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'">
                        {{ tool.done ? 'å®Œæˆ' : 'æ‰§è¡Œä¸­â€¦' }}
                      </span>
                    </div>
                    <div>
                      <p class="text-[10px] text-slate-400 uppercase tracking-wide mb-1">å‚æ•°</p>
                      <pre class="json-view bg-slate-800 text-slate-200 p-2 rounded-lg overflow-x-auto"
                        >{{ JSON.stringify(tool.args, null, 2) }}</pre>
                    </div>
                    <div v-if="tool.done">
                      <p class="text-[10px] text-slate-400 uppercase tracking-wide mb-1">è¿”å›ç»“æœ</p>
                      <pre class="json-view bg-slate-800 text-slate-200 p-2 rounded-lg overflow-x-auto"
                        >{{ JSON.stringify(tool.result, null, 2) }}</pre>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

        </template>

        <!-- ç­‰å¾…éª¨æ¶ -->
        <div v-if="isStreaming && !hasStreamStarted" class="flex gap-3 msg-enter">
          <div class="flex-none w-8 h-8 rounded-full bg-farm-500 flex items-center
                      justify-center text-white text-sm shadow">ğŸŒ±</div>
          <div class="bg-white rounded-2xl rounded-tl-sm shadow-sm px-4 py-3">
            <div class="flex gap-1 items-center h-5">
              <span class="w-2 h-2 rounded-full bg-farm-400 animate-bounce" style="animation-delay:0ms"></span>
              <span class="w-2 h-2 rounded-full bg-farm-400 animate-bounce" style="animation-delay:150ms"></span>
              <span class="w-2 h-2 rounded-full bg-farm-400 animate-bounce" style="animation-delay:300ms"></span>
            </div>
          </div>
        </div>

        <div ref="anchor"></div>
      </div>

      <!-- è¾“å…¥æ  -->
      <div class="flex-none border-t border-farm-100 bg-white/80 backdrop-blur px-4 py-3">
        <form @submit.prevent="sendMessage" class="flex gap-2 items-end">
          <div class="flex-1 relative">
            <textarea ref="inputEl" v-model="inputText"
              @keydown.enter.exact.prevent="sendMessage"
              @keydown.enter.shift.exact="inputText += '\n'"
              @input="autoResize"
              placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜â€¦ (Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ)"
              rows="1" :disabled="isStreaming"
              class="w-full resize-none rounded-xl border border-farm-200
                     focus:outline-none focus:ring-2 focus:ring-farm-400 focus:border-transparent
                     px-4 py-2.5 text-sm text-slate-800 bg-white
                     placeholder-slate-400 disabled:bg-slate-50 disabled:cursor-not-allowed
                     transition max-h-36 overflow-y-auto leading-relaxed">
            </textarea>
          </div>
          <button type="submit" :disabled="isStreaming || !inputText.trim()"
            class="flex-none w-10 h-10 rounded-xl bg-farm-600 hover:bg-farm-700
                   disabled:bg-slate-300 disabled:cursor-not-allowed
                   text-white flex items-center justify-center shadow-sm
                   transition active:scale-95">
            <svg v-if="!isStreaming" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
            <svg v-else class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/>
            </svg>
          </button>
        </form>
        <p class="text-[10px] text-slate-400 mt-1.5 text-center">
          å†œæ™º AI Â· ç”± DeepSeek é©±åŠ¨ Â· æ•°æ®ä»…ä¾›å‚è€ƒ
        </p>
      </div>

    </main>
  </div>
</div>

<script>
const { createApp, ref, nextTick, onMounted } = Vue

createApp({
  setup() {
    // â”€â”€â”€ å”¯ä¸€æ”¹åŠ¨ï¼šç›¸å¯¹è·¯å¾„ï¼ŒåŒæºè¯·æ±‚ï¼Œæ— éœ€ CORS â”€â”€â”€
    const API = '/api'

    const zones   = ['ä¸œåŒ—', 'è¥¿åŒ—', 'ä¸œå—', 'è¥¿å—']
    const sensors = ['ğŸŒ¡ï¸ æ¸©åº¦', 'ğŸ’§ æ¹¿åº¦', 'ğŸŒ«ï¸ COâ‚‚', 'â˜€ï¸ å…‰ç…§']
    const quickPrompts = [
      { icon: 'ğŸ“Š', text: 'æŸ¥çœ‹ä¸œå—åŒºæ¦‚å†µ' },
      { icon: 'ğŸ“ˆ', text: 'ä¸œåŒ—åŒºè¿‡å»6å°æ—¶æ¸©åº¦è¶‹åŠ¿' },
      { icon: 'ğŸ’§', text: 'ç»™è¥¿åŒ—åŒºæµ‡æ°´ 30 å‡' },
      { icon: 'ğŸ“‹', text: 'æŸ¥çœ‹æ“ä½œæ—¥å¿—' },
    ]

    const sessionId        = ref('')
    const isConnected      = ref(false)
    const messages         = ref([])
    const inputText        = ref('')
    const isStreaming      = ref(false)
    const hasStreamStarted = ref(false)

    const msgList = ref(null)
    const anchor  = ref(null)
    const inputEl = ref(null)

    const renderMd = (text) => {
      try { return marked.parse(text || '') } catch { return text || '' }
    }

    const scrollBottom = () => {
      nextTick(() => anchor.value?.scrollIntoView({ behavior: 'smooth' }))
    }

    const autoResize = () => {
      const el = inputEl.value
      if (!el) return
      el.style.height = 'auto'
      el.style.height = Math.min(el.scrollHeight, 144) + 'px'
    }

    // â”€â”€â”€ ä¼šè¯ç®¡ç† â”€â”€â”€
    const initSession = async () => {
      try {
        const res  = await fetch(`${API}/session`, { method: 'POST' })
        const data = await res.json()
        sessionId.value   = data.session_id
        isConnected.value = true
      } catch (e) {
        console.error('åˆå§‹åŒ–ä¼šè¯å¤±è´¥', e)
        isConnected.value = false
      }
    }

    const clearSession = async () => {
      if (isStreaming.value) return
      if (sessionId.value) {
        await fetch(`${API}/session/${sessionId.value}`, { method: 'DELETE' }).catch(() => {})
      }
      messages.value = []
      await initSession()
    }

    // â”€â”€â”€ å‘é€æ¶ˆæ¯ â”€â”€â”€
    const sendMessage = async () => {
      const text = inputText.value.trim()
      if (!text || isStreaming.value) return

      messages.value.push({ role: 'user', content: text })
      inputText.value = ''
      nextTick(autoResize)
      scrollBottom()

      isStreaming.value      = true
      hasStreamStarted.value = false

      let assistantMsgIdx = -1
      let toolGroupIdx    = -1

      const getOrCreateAssistant = () => {
        if (assistantMsgIdx === -1) {
          messages.value.push({ role: 'assistant', content: '', streaming: true })
          assistantMsgIdx        = messages.value.length - 1
          hasStreamStarted.value = true
        }
        return assistantMsgIdx
      }

      const getOrCreateToolGroup = () => {
        const last = messages.value[messages.value.length - 1]
        if (last && last.role === 'tool_group' && last.running) {
          toolGroupIdx = messages.value.length - 1
        } else {
          messages.value.push({ role: 'tool_group', tools: [], running: true, expanded: true })
          toolGroupIdx           = messages.value.length - 1
          hasStreamStarted.value = true
        }
        return toolGroupIdx
      }

      try {
        const resp = await fetch(`${API}/chat`, {
          method:  'POST',
          headers: { 'Content-Type': 'application/json' },
          body:    JSON.stringify({ session_id: sessionId.value, content: text }),
        })

        if (!resp.ok) {
          const err = await resp.json()
          messages.value.push({
            role: 'assistant',
            content: `âŒ é”™è¯¯ï¼š${err.error || resp.statusText}`,
            streaming: false,
          })
          return
        }

        // â”€â”€ è¯»å– SSE â”€â”€
        const reader  = resp.body.getReader()
        const decoder = new TextDecoder()
        let buf = ''

        const parseEvents = (raw) => {
          const events = []
          for (const block of raw.split('\n\n')) {
            if (!block.trim()) continue
            let eventType = '', dataStr = ''
            for (const line of block.split('\n')) {
              if (line.startsWith('event:')) eventType = line.slice(6).trim()
              else if (line.startsWith('data:')) dataStr = line.slice(5).trim()
            }
            if (eventType && dataStr) {
              try { events.push({ type: eventType, data: JSON.parse(dataStr) }) } catch {}
            }
          }
          return events
        }

        while (true) {
          const { done, value } = await reader.read()
          if (done) break

          buf += decoder.decode(value, { stream: true })

          const boundary = buf.lastIndexOf('\n\n')
          if (boundary === -1) continue

          const chunk = buf.slice(0, boundary + 2)
          buf = buf.slice(boundary + 2)

          for (const ev of parseEvents(chunk)) {
            handleSSEEvent(ev)
          }
        }

      } catch (e) {
        console.error(e)
        messages.value.push({
          role: 'assistant',
          content: `âŒ ç½‘ç»œé”™è¯¯ï¼š${e.message}`,
          streaming: false,
        })
      } finally {
        messages.value.forEach(m => {
          if (m.streaming) m.streaming = false
          if (m.running)   m.running   = false
        })
        isStreaming.value      = false
        hasStreamStarted.value = false
        assistantMsgIdx        = -1
        toolGroupIdx           = -1
        nextTick(() => inputEl.value?.focus())
      }

      function handleSSEEvent({ type, data }) {
        switch (type) {

          case 'text_delta': {
            const idx = getOrCreateAssistant()
            messages.value[idx].content += data.content
            scrollBottom()
            break
          }

          case 'text_done': {
            if (assistantMsgIdx !== -1)
              messages.value[assistantMsgIdx].streaming = false
            assistantMsgIdx = -1
            break
          }

          case 'tool_start': {
            const gIdx = getOrCreateToolGroup()
            messages.value[gIdx].tools.push({
              id:           data.id,
              name:         data.name,
              display_name: data.display_name,
              args:         data.args,
              result:       null,
              done:         false,
            })
            scrollBottom()
            break
          }

          case 'tool_done': {
            if (toolGroupIdx !== -1) {
              const tool = messages.value[toolGroupIdx].tools.find(t => t.id === data.id)
              if (tool) { tool.result = data.result; tool.done = true }
            }
            scrollBottom()
            break
          }

          case 'round_done': {
            if (toolGroupIdx !== -1) {
              messages.value[toolGroupIdx].running  = false
              messages.value[toolGroupIdx].expanded = false
            }
            toolGroupIdx    = -1
            assistantMsgIdx = -1
            break
          }

          case 'error': {
            messages.value.push({
              role: 'assistant', content: `âŒ é”™è¯¯ï¼š${data.message}`, streaming: false,
            })
            scrollBottom()
            break
          }

          case 'done': break
        }
      }
    }

    const sendQuick = (text) => {
      if (isStreaming.value) return
      inputText.value = text
      sendMessage()
    }

    onMounted(async () => {
      await initSession()
      inputEl.value?.focus()
    })

    return {
      zones, sensors, quickPrompts,
      messages, inputText, isStreaming, hasStreamStarted,
      isConnected, sessionId,
      msgList, anchor, inputEl,
      renderMd, sendMessage, sendQuick, clearSession, autoResize,
    }
  }
}).mount('#app')
</script>
</body>
</html>